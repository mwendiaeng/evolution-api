version: "3.8"

services:

  # ------------------------
  # Evolution API
  # ------------------------
  api:
    container_name: evolution_api
    image: evoapicloud/evolution-api:latest
    build: .
    restart: always

    depends_on:
      redis:
        condition: service_healthy
      evolution-postgres:
        condition: service_healthy

    ports:
      - "127.0.0.1:8080:8080"

    volumes:
      - evolution_instances:/evolution/instances
      - ./docker-logs:/evolution/logs

    env_file:
      - .env.prod

    networks:
      - evolution-net
      - dokploy-network
      - devdreams

    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"

    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:8080/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5


  # ------------------------
  # Manager UI
  # ------------------------
  frontend:
    container_name: evolution_frontend
    image: evoapicloud/evolution-manager:latest
    build: ./evolution-manager-v2
    restart: always

    ports:
      - "127.0.0.1:3000:80"

    networks:
      - evolution-net

    logging:
      driver: json-file
      options:
        max-size: "20m"
        max-file: "5"


  # ------------------------
  # Redis (internal only)
  # ------------------------
  redis:
    container_name: evolution_redis
    image: redis:7.2-alpine
    restart: always

    command: redis-server --appendonly yes

    volumes:
      - evolution_redis:/data

    networks:
      - evolution-net

    expose:
      - "6379"

    logging:
      driver: json-file
      options:
        max-size: "20m"
        max-file: "5"

    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 20s
      timeout: 3s
      retries: 5


  # ------------------------
  # Postgres (non-standard host port)
  # ------------------------
  evolution-postgres:
    container_name: evolution_postgres
    image: postgres:15.5-alpine
    restart: always

    env_file:
      - .env.prod

    command:
      - postgres
      - -c
      - listen_addresses=0.0.0.0
      - -c
      - max_connections=300

    environment:
      POSTGRES_DB: ${POSTGRES_DATABASE}
      POSTGRES_USER: ${POSTGRES_USERNAME}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}

    # üîê Host DB already uses 5432 ‚Üí map container to 55432
    ports:
      - "127.0.0.1:55432:5432"

    volumes:
      - postgres_data:/var/lib/postgresql/data

    networks:
      - evolution-net

    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USERNAME}"]
      interval: 30s
      timeout: 5s
      retries: 5


# ------------------------
# Volumes
# ------------------------
volumes:
  evolution_instances:
  evolution_redis:
  postgres_data:


# ------------------------
# Networks
# ------------------------
networks:
  evolution-net:
    name: evolution-net
    driver: bridge

  dokploy-network:
    external: true

  devdreams:
    external: true
